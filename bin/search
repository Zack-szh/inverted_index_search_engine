#!/bin/bash

set -Eeuo pipefail

start() {
  echo "starting search server ..."
  
  # Check if database exists
  if [ ! -f "var/search.sqlite3" ]; then
    echo "Error: can't find search database var/search.sqlite3"
    echo "Try: ./bin/searchdb"
    exit 1
  fi
  
  # Check if search server is already running
  SEARCH_PROCS=$(set +e; pgrep -f "flask --app search run --host 0.0.0.0 --port 8000" | wc -l; set -e)
  if [ "$SEARCH_PROCS" -gt 0 ]; then
    echo "Error: search server is already running"
    exit 1
  fi
  
  # Check if index servers are running (need exactly 3)
  INDEX_PROCS=$(set +e; pgrep -af "flask.*index_server.index" | wc -l; set -e)
  if [ "$INDEX_PROCS" -ne 3 ]; then
    echo "Error: index server is not running"
    echo "Try ./bin/index start"
    exit 1
  fi
  
  mkdir -p var/log
  rm -f var/log/search.log

  flask --app search run --host 0.0.0.0 --port 8000 &> var/log/search.log &
}

stop() {
  echo "stopping search server ..."
  pkill -f "flask --app search run --host 0.0.0.0 --port 8000" || true
}

restart() {
  echo "restarting search server ..."
  stop
  start
}

status() {
  NPROCS=$(set +e; pgrep -f "flask --app search run --host 0.0.0.0 --port 8000" | wc -l; set -e)
  if [ "$NPROCS" -eq 1 ]; then
    echo "search server running"
  elif [ "$NPROCS" -eq 0 ]; then
    echo "search server stopped"
    exit 1
  else
    echo "search server error: found ${NPROCS} processes, expected 1"
    exit 2
  fi
}

case "$1" in
  start)
    start
    ;;
  stop)
    stop
    ;;
  restart)
    restart
    ;;
  status)
    status
    ;;
  *)
    echo "Usage: $0 {start|stop|restart|status}"
    exit 1
    ;;
esac